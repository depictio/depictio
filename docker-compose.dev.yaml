services:
  mongo:
    image: mongo:8.0.14
    container_name: mongo
    command: mongod --dbpath /data/db --port 27018
    user: "${UID:-1000}:${GID:-1000}"
    ports:
      - ${MONGO_PORT:-27018}:27018
    volumes:
      - ./${DATA_DIR:-data}/depictioDB:/data/db

  redis:
    image: redis:8.2.1
    container_name: redis
    ports:
      - ${REDIS_PORT:-6379}:6379
    volumes:
      - ./${DATA_DIR:-data}/redis:/data
    command: redis-server --dir /data --save 60 1
    user: "${UID:-1000}:${GID:-1000}"
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 3s
      retries: 5

  minio:
    image: minio/minio:RELEASE.2025-01-20T14-49-07Z
    container_name: minio
    user: "${UID:-1000}:${GID:-1000}"
    volumes:
      - ./${DATA_DIR:-data}/minio_data:/data
    environment:
      MINIO_ROOT_USER: ${DEPICTIO_MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${DEPICTIO_MINIO_ROOT_PASSWORD:-minio123}
    command: server /data --console-address :9001
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9000/minio/health/live || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  depictio-frontend:
    container_name: depictio-frontend
    # Use prebuilt image if DEPICTIO_VERSION is set, otherwise build locally
    image: ${DEPICTIO_VERSION:-depictio:dev}
    build:
      # Use simplified uv-based Dockerfile (faster builds, pure Python)
      # Falls back to conda-based Dockerfile_depictio.dockerfile if needed
      dockerfile: docker-images/Dockerfile_depictio_uv.dockerfile
      context: .
    ports:
      - ${DASH_PORT:-5080}:5080
    volumes:
      - ./depictio:/app/depictio
      - ./docker-images/run_dash.sh:/app/run_dash.sh
      - ./pyproject.toml:/app/pyproject.toml
      - ./VERSION:/app/VERSION
      - ./${DATA_DIR}/prof_files:/app/prof_files
      - ./${DATA_DIR}/cache:/app/cache
      - ./${DATA_DIR}/minio_data:/app/minio_data
    env_file:
      - docker-compose/.env
    environment:
        DEPICTIO_DEV_MODE: "${DEPICTIO_DEV_MODE:-false}"
        DEPICTIO_LOGGING_VERBOSITY_LEVEL: "${DEPICTIO_LOGGING_VERBOSITY_LEVEL:-DEBUG}"
        DEPICTIO_AUTH_SINGLE_USER_MODE: "${DEPICTIO_AUTH_SINGLE_USER_MODE:-false}"
        # Use mounted volume for S3 cache persistence across container restarts
        DEPICTIO_S3_CACHE_DIR: "/app/cache/s3_files"
    command: ["/app/run_dash.sh"]
    user: "${UID:-1000}:${GID:-1000}"
    depends_on:
      - mongo
      - redis
      - depictio-backend
      - minio

  depictio-backend:
    container_name: depictio-backend
    # Use prebuilt image if DEPICTIO_VERSION is set, otherwise build locally
    image: ${DEPICTIO_VERSION:-depictio:dev}
    build:
      dockerfile: docker-images/Dockerfile_depictio_uv.dockerfile
      context: .
    ports:
      - ${FASTAPI_PORT:-8058}:8058
    volumes:
      - ./depictio:/app/depictio
      - ./dashboards:/app/dashboards
      - ./pyproject.toml:/app/pyproject.toml
      - ./VERSION:/app/VERSION
      - ./docker-images/run_fastapi.sh:/app/run_fastapi.sh
      - ./${DATA_DIR}/prof_files:/app/prof_files
      - ./${DATA_DIR}/minio_data:/app/minio_data
    env_file:
      - docker-compose/.env
    environment:
        DEPICTIO_DEV_MODE: "${DEPICTIO_DEV_MODE:-false}"
        DEPICTIO_LOGGING_VERBOSITY_LEVEL: "${DEPICTIO_LOGGING_VERBOSITY_LEVEL:-DEBUG}"
        DEPICTIO_AUTH_SINGLE_USER_MODE: "${DEPICTIO_AUTH_SINGLE_USER_MODE:-false}"
        DEPICTIO_FASTAPI_WORKERS: "${DEPICTIO_FASTAPI_WORKERS:-4}"
        DEPICTIO_FASTAPI_EXTERNAL_PORT: "${DEPICTIO_FASTAPI_EXTERNAL_PORT:-8058}"
        DEPICTIO_FASTAPI_EXTERNAL_HOST: "${DEPICTIO_FASTAPI_EXTERNAL_HOST:-localhost}"
        DEPICTIO_DASH_EXTERNAL_PORT: "${DEPICTIO_DASH_EXTERNAL_PORT:-5080}"
        DEPICTIO_DASH_EXTERNAL_HOST: "${DEPICTIO_DASH_EXTERNAL_HOST:-localhost}"
        DEPICTIO_MINIO_EXTERNAL_PORT: "${DEPICTIO_MINIO_EXTERNAL_PORT:-9000}"
        DEPICTIO_MINIO_EXTERNAL_HOST: "${DEPICTIO_MINIO_EXTERNAL_HOST:-localhost}"
    command: ["/app/run_fastapi.sh"]
    user: "${UID:-1000}:${GID:-1000}"
    depends_on:
      - mongo
      - redis
      - minio

  depictio-celery-worker:
    container_name: depictio-celery-worker
    # Use the same image as backend
    image: ${DEPICTIO_VERSION:-depictio:dev}
    build:
      dockerfile: docker-images/Dockerfile_depictio_uv.dockerfile
      context: .
    volumes:
      - ./depictio:/app/depictio
      - ./dashboards:/app/dashboards
      - ./pyproject.toml:/app/pyproject.toml
      - ./docker-images/run_celery_worker.sh:/app/run_celery_worker.sh
      - ./${DATA_DIR}/prof_files:/app/prof_files
    env_file:
      - docker-compose/.env
    environment:
        DEPICTIO_DEV_MODE: "${DEPICTIO_DEV_MODE:-false}"
        DEPICTIO_LOGGING_VERBOSITY_LEVEL: "${DEPICTIO_LOGGING_VERBOSITY_LEVEL:-DEBUG}"
        DEPICTIO_AUTH_SINGLE_USER_MODE: "${DEPICTIO_AUTH_SINGLE_USER_MODE:-false}"
        DEPICTIO_CONTEXT: "server"
    command: ["/app/run_celery_worker.sh"]
    user: "${UID:-1000}:${GID:-1000}"
    depends_on:
      - mongo
      - redis
      - depictio-backend
      - minio
