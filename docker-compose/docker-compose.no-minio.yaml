# ============================================================================
# DEPICTIO DOCKER COMPOSE - EXTERNAL S3 / NO MINIO
# ============================================================================
# Use this file when you bring your own S3 or external MinIO instance.
# MinIO is NOT included â€” configure your S3 credentials in .env instead.
#
# USAGE:
#   docker compose -f docker-compose/docker-compose.no-minio.yaml up -d
#
# REQUIRED .env settings for external S3:
#   DEPICTIO_MINIO_ROOT_USER=your-access-key
#   DEPICTIO_MINIO_ROOT_PASSWORD=your-secret-key
#
# OPTIONAL .env settings (uncomment as needed):
#   DEPICTIO_MINIO_PUBLIC_URL=https://your-s3-endpoint
#   DEPICTIO_MINIO_EXTERNAL_SERVICE=true
#   DEPICTIO_MINIO_EXTERNAL_HOST=your-s3-host
#   DEPICTIO_MINIO_EXTERNAL_PORT=443
#
# For bundled MinIO (recommended for most users), use instead:
#   docker compose up -d   (from the repo root)
# ============================================================================

services:
  mongo:
    image: mongo:8.0.14
    container_name: mongo
    command: mongod --dbpath /data/depictioDB --port 27018 --logpath /dev/null
    ports:
      - 27018:27018
    volumes:
      - mongo_data:/data/depictioDB
    healthcheck:
      test: ["CMD-SHELL", "mongosh --port 27018 --eval 'db.adminCommand(\"ping\")'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  redis:
    image: redis:8.2.1
    container_name: redis
    ports:
      - 6379:6379
    volumes:
      - redis_data:/data
    command: redis-server
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  depictio-frontend:
    image: ghcr.io/depictio/depictio:${DEPICTIO_VERSION:-latest}
    container_name: depictio-frontend
    ports:
      - 5080:5080
    env_file:
      - path: .env
        required: false
    command: ["/app/run_dash.sh"]
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5080/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
      depictio-backend:
        condition: service_healthy

  depictio-backend:
    image: ghcr.io/depictio/depictio:${DEPICTIO_VERSION:-latest}
    container_name: depictio-backend
    ports:
      - 8058:8058
    env_file:
      - path: .env
        required: false
    command: ["/app/run_fastapi.sh"]
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8058/depictio/api/v1/docs"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy

  depictio-celery-worker:
    container_name: depictio-celery-worker
    # Always enabled - required for design mode (stepper) to work
    # Dashboard editor will fail without Celery worker running
    image: ghcr.io/depictio/depictio:${DEPICTIO_VERSION:-latest}
    env_file:
      - path: .env
        required: false
    environment:
        DEPICTIO_CONTEXT: "server"
    command: ["/app/run_celery_worker.sh"]
    restart: unless-stopped
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
      depictio-backend:
        condition: service_healthy

volumes:
  mongo_data:
    driver: local
  redis_data:
    driver: local
