# Pixi configuration for depictio
# This allows running the project without Docker using pixi (https://pixi.sh)
# Install pixi: curl -fsSL https://pixi.sh/install.sh | bash
# Then run: pixi install

[project]
name = "depictio"
version = "0.6.0-b2"
description = "Depictio - Dashboard generation from workflows outputs"
authors = ["Thomas Weber <thomas.weber@embl.de>"]
channels = ["conda-forge"]
platforms = ["linux-64", "osx-arm64", "osx-64"]

[tasks]
# =============================================================================
# Infrastructure services (MongoDB, Redis, MinIO)
# =============================================================================
# Initialize data directories
init-data-dirs = "mkdir -p .pixi-data/mongodb .pixi-data/redis .pixi-data/minio"

# Start MongoDB on port 27018 (matching docker-compose config)
start-mongo = { cmd = "mongod --dbpath .pixi-data/mongodb --port 27018 --bind_ip 127.0.0.1 --logpath .pixi-data/mongodb/mongod.log --fork", depends-on = ["init-data-dirs"] }
stop-mongo = "mongosh --port 27018 --eval 'db.adminCommand({shutdown: 1})' || true"

# Start Redis on port 6379
start-redis = { cmd = "redis-server --daemonize yes --port 6379 --dir .pixi-data/redis --logfile redis.log", depends-on = ["init-data-dirs"] }
stop-redis = "redis-cli -p 6379 shutdown || true"

# Start MinIO on port 9000 (API) and 9001 (Console)
start-minio = { cmd = "minio server .pixi-data/minio --address :9000 --console-address :9001 > .pixi-data/minio/minio.log 2>&1 &", depends-on = ["init-data-dirs"] }
stop-minio = "pkill -f 'minio server' || true"

# Start all infrastructure services
start-infra = { depends-on = ["start-mongo", "start-redis", "start-minio"] }
stop-infra = { depends-on = ["stop-mongo", "stop-redis", "stop-minio"] }

# Check infrastructure status
status-infra = """
echo "=== Infrastructure Status ===" && \
echo -n "MongoDB (27018): " && (mongosh --port 27018 --eval 'db.runCommand({ping:1})' --quiet 2>/dev/null && echo "running" || echo "stopped") && \
echo -n "Redis (6379): " && (redis-cli -p 6379 ping 2>/dev/null || echo "stopped") && \
echo -n "MinIO (9000): " && (curl -s http://localhost:9000/minio/health/live && echo " running" || echo "stopped")
"""

# =============================================================================
# Application services
# =============================================================================
install-browsers = "playwright install chromium"
api = { cmd = "python depictio/api/run.py", depends-on = ["install-browsers"] }
dash = "python depictio/dash/flask_dispatcher.py"
celery = "celery -A depictio.api.celery_app worker --loglevel=info"

# Start everything (infrastructure + app)
start-all = { cmd = "echo 'Starting API...' && python depictio/api/run.py", depends-on = ["start-infra", "install-browsers"] }

# =============================================================================
# Testing tasks
# =============================================================================
test = "pytest depictio/tests/ -xvs"
test-fast = "pytest depictio/tests/ -x --ignore=depictio/tests/e2e-tests"

# =============================================================================
# Code quality tasks
# =============================================================================
lint = "ruff check depictio/"
format = "ruff format depictio/"
typecheck = "ty check depictio/"
pre-commit = "pre-commit run --all-files"

[dependencies]
# Python version constraint
python = ">=3.11,<3.13"

# Infrastructure services (installed via conda-forge)
# Note: conda-forge mongodb is at 6.0.x, not 7.x
mongodb = ">=6.0"
redis-server = ">=7.0"
# minio-server is the server binary (not minio which is the Python SDK)
minio-server = "*"

# Platform-specific dependencies are defined in [target.<platform>.dependencies] below

[target.linux-64.dependencies]
# System dependencies for playwright/headless browser (Linux only)
xvfb-run = "*"

[pypi-dependencies]
# All Python dependencies are managed via pypi for simplicity
# This references the pyproject.toml which contains the full dependency list
depictio = { path = ".", editable = true }

[feature.dev.dependencies]
# Development tools that benefit from conda (faster installation)
pre-commit = "*"

[feature.dev.pypi-dependencies]
# Development Python packages
ruff = ">=0.12.1"
ty = ">=0.0.1-alpha.12"
pytest = ">=8.4.1"
pytest-asyncio = ">=1.0.0"
pytest-xdist = ">=3.7.0"
pytest-cov = "*"
mongomock = ">=4.3.0"
mongomock-motor = ">=0.0.36"
bump2version = "*"
testcontainers = { version = "*", extras = ["minio"] }

[environments]
# Default environment with all features
default = { features = ["dev"], solve-group = "default" }

# Production-like environment (minimal)
prod = { features = [], solve-group = "prod" }

[activation]
scripts = ["scripts/setup_env.sh"]

[system-requirements]
# Linux system requirements for playwright browsers
linux = "4.4"
