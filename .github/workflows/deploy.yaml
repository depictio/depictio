name: Deploy and Test Depictio

on:
  push:
    branches: "*"
  pull_request:
    branches: [main]

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
        with:
          submodules: recursive  # Clone with submodules

      - name: Clone Example Data Repository
        run: git clone https://github.com/depictio/depictio-data.git

      - name: Create MongoDB Data Directory
        run: mkdir -p depictioDB/ && chown -R root:root depictioDB/ && chmod -R 775 depictioDB/

      - name: Set up Environment Variables
        run: echo "DEPICTIO_BACKEND_DATA_VOLUME_HOST=$(pwd)/depictio-data" >> .env

      - name: Start Docker Compose Services
        run: docker compose up -d

      - name: Wait for Services to Start
        run: sleep 60  # Adjust the wait time if necessary

      - name: Make sure all Services Are Running
        run: |
          docker ps
          docker logs depictio_frontend
          docker logs depictio_backend

        # Clone the depictio-cli repository
      - name: Clone Depictio-CLI Repository
        run: git clone https://github.com/depictio/depictio-cli.git


      # Pwd & list files
      - name: Print Working Directory
        run: pwd
      
      - name: List Files
        run: ls -la


      # List content of depictio
      - name: List Depictio Directory
        run: ls -lal depictio

      - name: Show agent config file
        run: cat depictio/.depictio/default_admin_agent.yaml
      


      # Go to the Depictio-CLI directory
      - name: Change Directory to Depictio-CLI
        run: cd depictio-cli

      - name: Set Up Python Environment
        run: python -m venv depictio-cli-venv

      - name: Activate Virtual Environment and Install Depictio-CLI
        run: |
          source depictio-cli-venv/bin/activate
          pip install -e .
          export PYTHONPATH=$PYTHONPATH:$(pwd)/depictio-cli

      - name: Ingest Data
        run: |
          depictio-cli data setup \
            --agent-config-path ../depictio/.depictio/default_admin_agent.yaml \
            --pipeline-config-path configs/mosaicatcher_pipeline/mosaicatcher_pipeline.yaml \
            --scan-files

      - name: Check Ingestion Success
        run: |
          # Your check logic here
          echo "Data ingestion completed successfully"
