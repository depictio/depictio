name: Deploy and Test Depictio

on:
  push:
    branches: "*"
  pull_request:
    branches: [main]

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
        with:
          submodules: recursive # Clone with submodules

      - name: Clone Example Data Repository
        run: git clone https://github.com/depictio/depictio-data.git

      - name: Create and Set Permissions for depictioDB
        run: |
          sudo mkdir -p depictioDB/
          sudo chown -R $(id -u):$(id -g) depictioDB/
          sudo chmod -R 777 depictioDB/

      - name: Create and Set Permissions for minio_data
        run: |
          sudo mkdir -p minio_data/
          sudo chown -R $(id -u):$(id -g) minio_data/
          sudo chmod -R 775 minio_data/

      - name: Create and Set Permissions for depictio/keys
        run: |
          sudo mkdir -p depictio/keys/
          sudo chmod -R 775 depictio/keys/
          sudo chown -R runner:docker depictio/keys/

      - name: Create and Set Permissions for depictio/.depictio
        run: |
          sudo mkdir -p depictio/.depictio/
          sudo chmod -R 775 depictio/.depictio/
          sudo chown -R runner:docker depictio/.depictio/

      - name: Set Environment Variables
        run: |
          echo "UID=$(id -u)" >> $GITHUB_ENV
          echo "GID=$(id -g)" >> $GITHUB_ENV
          echo "MINIO_ROOT_USER=minio" >> $GITHUB_ENV
          echo "MINIO_ROOT_PASSWORD=minio123" >> $GITHUB_ENV
        

      - name: Set up Environment Variables
        run: echo "DEPICTIO_BACKEND_DATA_VOLUME_HOST=$(pwd)/depictio-data" >> .env


        
      - name: Start Docker Compose Services
        run: docker compose up -d

      - name: Verify Permissions Inside Container
        run: |
          docker compose exec -T depictio_backend bash -c "ls -la /app/depictio/keys"

      - name: List Files
        run: ls -la

      - name: List Files
        run: ls -la depictio

      - name: Wait for Services to Start
        run: sleep 10 # Adjust the wait time if necessary

      # Step 5: Verify All Containers Are Running
      - name: Check if all containers are running
        run: |
          # Check if any containers are not in the 'Up' state
          if ! docker compose ps | grep -q 'Up'; then
            echo "One or more containers are not running. Failing the step."
            docker compose ps
            exit 1
          fi

      - name: Make sure all Services Are Running
        run: |
          docker ps
          docker logs depictio-depictio_frontend-1
          docker logs depictio-depictio_backend-1
          docker logs depictio-minio-1
          docker logs depictio-mongo-1

        # Clone the depictio-cli repository
      - name: Clone Depictio-CLI Repository
        run: git clone https://github.com/depictio/depictio-cli.git

      # Pwd & list files
      - name: Print Working Directory
        run: pwd

      - name: List Files
        run: ls -la

      - name: List Files
        run: ls -la depictioDB/

      # List content of depictio
      - name: List Depictio Directory
        run: ls -lal depictio

      # List content of depictio
      - name: List Depictio Directory
        run: ls -lal depictio/.depictio

      # List content of depictio
      - name: List Depictio Directory
        run: ls -lal .

      # List content of depictio
      - name: List Depictio Directory
        run: ls -lal depictio/keys

      # List content of depictio
      - name: List Depictio Directory
        run: ls -lal ../

      # Verify permissions inside MongoDB container
      - name: Verify MongoDB Permissions Inside Container
        run: |
          docker compose exec -T mongo bash -c "ls -la /data/depictioDB"

      # Verify permissions inside MinIO container
      - name: Verify MinIO Permissions Inside Container
        run: |
          docker compose exec -T minio bash -c "ls -la /data"


      - name: Show agent config file
        run: docker compose exec depictio_backend cat /app/depictio/.depictio/default_admin_agent.yaml
        # run: cat depictio/.depictio/default_admin_agent.yaml

      # Go to the Depictio-CLI directory
      - name: Change Directory to Depictio-CLI
        working-directory: depictio-cli
        run: pwd

      - name: Set Up Python Environment
        run: python -m venv depictio-cli-venv

      - name: Activate Virtual Environment and Install Depictio-CLI
        working-directory: depictio-cli
        run: |
          # Use the explicit path to python and pip in the virtual environment
          depictio-cli-venv/bin/python -m pip install --upgrade pip
          depictio-cli-venv/bin/pip install -e .

      - name: Ingest Data
        working-directory: depictio-cli
        run: |
          # Use the explicit path to the virtual environment's python
          depictio-cli-venv/bin/python -m depictio_cli data setup \
            --agent-config-path ../depictio/.depictio/default_admin_agent.yaml \
            --pipeline-config-path configs/mosaicatcher_pipeline/mosaicatcher_pipeline.yaml \
            --scan-files

      - name: Check Ingestion Success
        run: echo "Data ingestion completed successfully"