name: Deploy to EMBL (Self-Hosted)

# SECURITY NOTE: This workflow uses self-hosted runners.
# It triggers after Docker build completes (not directly on tags).
# Only users with write access can push tags.

on:
  # Trigger after Docker build workflows complete
  workflow_run:
    workflows:
      - "Docker Image Build (AMD64) - Beta only"  # Beta tags (v*-b*)
      - "Docker Image Multi Arch Build"            # Stable tags (v*)
    types:
      - completed

  # Manual dispatch for any version
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to deploy (without v prefix, e.g., 0.6.0-b18, 0.6.0, 0.6.1)'
        required: true
        type: string
      environment:
        description: 'Target environment (dev for beta, demo for stable, both for dual deployment)'
        required: true
        type: choice
        options:
          - dev
          - demo
          - both
      register_projects:
        description: 'Register demo projects after deployment'
        required: false
        type: boolean
        default: true

# Prevent concurrent deployments
concurrency:
  group: embl-deploy-${{ github.event.workflow_run.head_branch || github.ref }}
  cancel-in-progress: false

jobs:
  # Detect tag type (beta vs stable) for workflow_run events
  detect-tag-type:
    name: Detect Tag Type
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'
    outputs:
      is_beta: ${{ steps.detect.outputs.is_beta }}
      is_stable: ${{ steps.detect.outputs.is_stable }}
      version: ${{ steps.detect.outputs.version }}
    steps:
      - name: Detect tag type from ref
        id: detect
        run: |
          # Extract ref from workflow_run event
          REF="${{ github.event.workflow_run.head_branch }}"
          echo "Workflow run ref: ${REF}"

          # Remove 'v' prefix if present
          VERSION="${REF#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          # Check if this is a beta tag (contains -b)
          if [[ "${VERSION}" =~ -b[0-9]+ ]]; then
            echo "is_beta=true" >> $GITHUB_OUTPUT
            echo "is_stable=false" >> $GITHUB_OUTPUT
            echo "âœ… Detected BETA tag: ${VERSION}"
          else
            echo "is_beta=false" >> $GITHUB_OUTPUT
            echo "is_stable=true" >> $GITHUB_OUTPUT
            echo "âœ… Detected STABLE tag: ${VERSION}"
          fi

  # Dev environment - Beta tags deploy here automatically
  deploy-dev:
    name: Deploy to Dev (dev.demo.depictio.embl.org)
    runs-on: [self-hosted, embl-deploy]
    environment: embl-demo-dev
    needs: [detect-tag-type]
    if: |
      always() &&
      (
        (github.event_name == 'workflow_run' && needs.detect-tag-type.result == 'success' && needs.detect-tag-type.outputs.is_beta == 'true') ||
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'dev' || github.event.inputs.environment == 'both'))
      )
    # Run for:
    # 1. Beta tags (workflow_run with is_beta=true)
    # 2. Manual dispatch targeting dev/both
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all tags for validation

      - name: Display available recent tags
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ðŸ“‹ Recent available tags:"
          echo "Beta tags (for dev environment):"
          git tag -l 'v*-b*' --sort=-version:refname | head -10 | sed 's/^v/  - /'
          echo ""
          echo "Stable tags (for demo environment):"
          git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-version:refname | grep -v '\-b' | head -10 | sed 's/^v/  - /'

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Use version from detect-tag-type job
            VERSION="${{ needs.detect-tag-type.outputs.version }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Deploying version: ${VERSION}"

      - name: Validate tag exists
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v${VERSION}"

          echo "ðŸ” Validating tag: ${TAG}"

          if git rev-parse "${TAG}" >/dev/null 2>&1; then
            echo "âœ… Tag ${TAG} exists"
          else
            echo "âŒ Error: Tag ${TAG} does not exist!"
            echo "Available recent tags:"
            git tag -l 'v*' --sort=-version:refname | head -20
            exit 1
          fi

      - name: Wait for Docker image to be available
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          IMAGE="ghcr.io/depictio/depictio:${VERSION}"
          echo "Checking for image: ${IMAGE}"

          for i in {1..30}; do
            if docker manifest inspect "${IMAGE}" > /dev/null 2>&1; then
              echo "Image ${IMAGE} is available"
              break
            fi
            echo "Waiting for image... (attempt $i/30)"
            sleep 10
          done

      - name: Deploy to Dev environment
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "ðŸš€ Deploying version ${VERSION} to dev.demo.depictio.embl.org"

          helm upgrade --install devdemo ./helm-charts/depictio \
            --namespace datasci-depictio-project-demo-dev \
            -f helm-charts/depictio/values.yaml \
            -f helm-charts/depictio/values-embl-unauth.yaml \
            -f helm-charts/depictio/values-embl-demo-dev.yaml \
            -f ~/actions-runner-embl/secrets/values-embl-secrets.yaml \
            --set backend.image.tag="${VERSION}" \
            --set frontend.image.tag="${VERSION}" \
            --wait --timeout 10m --atomic \
            --insecure-skip-tls-verify

          echo "âœ… Dev deployment complete"

      - name: Verify deployment
        run: |
          echo "ðŸ“‹ Checking deployment status..."
          kubectl get pods -n datasci-depictio-project-demo-dev -l release=devdemo,type=app
          kubectl get ingress -n datasci-depictio-project-demo-dev

      - name: Wait for services to be ready
        run: |
          echo "â³ Waiting for backend to be ready..."
          kubectl wait --for=condition=ready pod \
            -l release=devdemo,app=depictio-backend \
            -n datasci-depictio-project-demo-dev \
            --timeout=300s

          echo "â³ Waiting for frontend to be ready..."
          kubectl wait --for=condition=ready pod \
            -l release=devdemo,app=depictio-frontend \
            -n datasci-depictio-project-demo-dev \
            --timeout=300s

          echo "âœ… All services are ready"

  # Register demo projects after dev deployment
  register-projects-dev:
    name: Register Demo Projects (Dev)
    runs-on: [self-hosted, embl-deploy]
    needs: deploy-dev
    if: |
      (github.event_name == 'workflow_run') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.register_projects == 'true')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python and CLI
        run: |
          # Use system Python or install via uv
          if command -v uv &> /dev/null; then
            cd depictio/cli
            uv venv venv --python 3.11
            source venv/bin/activate
            uv pip install -e .
          else
            cd depictio/cli
            python3 -m venv venv
            source venv/bin/activate
            pip install -e .
          fi

      - name: Get admin token from backend pod
        id: token
        run: |
          # Get admin config from backend pod
          BACKEND_POD=$(kubectl get pods -n datasci-depictio-project-demo-dev \
            -l release=devdemo,app=depictio-backend \
            -o jsonpath='{.items[0].metadata.name}')

          echo "Getting admin config from pod: ${BACKEND_POD}"
          kubectl cp datasci-depictio-project-demo-dev/${BACKEND_POD}:/app/depictio/.depictio/admin_config.yaml ./admin_config.yaml

          # Mask the token in logs
          TOKEN=$(grep 'access_token' admin_config.yaml | awk '{print $2}' | tr -d "'\"")
          echo "::add-mask::${TOKEN}"
          echo "token=${TOKEN}" >> $GITHUB_OUTPUT

      - name: Register Iris demo project
        run: |
          cd depictio/cli
          source venv/bin/activate

          echo "ðŸ“Š Registering Iris demo project..."
          depictio-cli config validate-project-config \
            --project-config-path ../api/v1/configs/iris_dataset/initial_project_cli.yaml \
            --CLI-config-path ../../admin_config.yaml || true

          # Register the project (if command exists)
          # depictio-cli project register \
          #   --project-config-path ../api/v1/configs/iris_dataset/initial_project_cli.yaml \
          #   --CLI-config-path ../../admin_config.yaml || true

      - name: Cleanup
        if: always()
        run: |
          rm -f admin_config.yaml

  # Demo environment - Only STABLE tags (no -b* suffix) deploy here
  deploy-demo:
    name: Deploy to Demo (demo.depictio.embl.org)
    runs-on: [self-hosted, embl-deploy]
    environment: embl-demo
    needs: [detect-tag-type]
    if: |
      always() &&
      (
        (github.event_name == 'workflow_run' && needs.detect-tag-type.result == 'success' && needs.detect-tag-type.outputs.is_stable == 'true') ||
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'demo' || github.event.inputs.environment == 'both'))
      )
    # Run for:
    # 1. Stable tags (workflow_run with is_stable=true)
    # 2. Manual dispatch targeting demo/both
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all tags for validation

      - name: Display available recent tags
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ðŸ“‹ Recent available tags:"
          echo "Beta tags (for dev environment):"
          git tag -l 'v*-b*' --sort=-version:refname | head -10 | sed 's/^v/  - /'
          echo ""
          echo "Stable tags (for demo environment):"
          git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-version:refname | grep -v '\-b' | head -10 | sed 's/^v/  - /'

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Use version from detect-tag-type job
            VERSION="${{ needs.detect-tag-type.outputs.version }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Deploying version: ${VERSION}"

      - name: Validate tag exists
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v${VERSION}"

          echo "ðŸ” Validating tag: ${TAG}"

          if git rev-parse "${TAG}" >/dev/null 2>&1; then
            echo "âœ… Tag ${TAG} exists"
          else
            echo "âŒ Error: Tag ${TAG} does not exist!"
            echo "Available recent tags:"
            git tag -l 'v*' --sort=-version:refname | head -20
            exit 1
          fi

      - name: Wait for Docker image to be available
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          IMAGE="ghcr.io/depictio/depictio:${VERSION}"
          echo "Checking for image: ${IMAGE}"

          for i in {1..30}; do
            if docker manifest inspect "${IMAGE}" > /dev/null 2>&1; then
              echo "Image ${IMAGE} is available"
              break
            fi
            echo "Waiting for image... (attempt $i/30)"
            sleep 10
          done

      - name: Deploy to Demo environment
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "ðŸš€ Deploying version ${VERSION} to demo.depictio.embl.org"

          helm upgrade --install demo ./helm-charts/depictio \
            --namespace datasci-depictio-project-demo \
            -f helm-charts/depictio/values.yaml \
            -f helm-charts/depictio/values-embl-unauth.yaml \
            -f helm-charts/depictio/values-embl-demo.yaml \
            -f ~/actions-runner-embl/secrets/values-embl-secrets.yaml \
            --set backend.image.tag="${VERSION}" \
            --set frontend.image.tag="${VERSION}" \
            --wait --timeout 10m --atomic \
            --insecure-skip-tls-verify

          echo "âœ… Demo deployment complete"

      - name: Verify deployment
        run: |
          echo "ðŸ“‹ Checking deployment status..."
          kubectl get pods -n datasci-depictio-project-demo -l release=demo,type=app
          kubectl get ingress -n datasci-depictio-project-demo

      - name: Wait for services to be ready
        run: |
          echo "â³ Waiting for backend to be ready..."
          kubectl wait --for=condition=ready pod \
            -l release=demo,app=depictio-backend \
            -n datasci-depictio-project-demo \
            --timeout=300s

          echo "â³ Waiting for frontend to be ready..."
          kubectl wait --for=condition=ready pod \
            -l release=demo,app=depictio-frontend \
            -n datasci-depictio-project-demo \
            --timeout=300s

          echo "âœ… All services are ready"

  # Register demo projects after demo deployment
  register-projects-demo:
    name: Register Demo Projects (Demo)
    runs-on: [self-hosted, embl-deploy]
    needs: deploy-demo
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.register_projects == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python and CLI
        run: |
          if command -v uv &> /dev/null; then
            cd depictio/cli
            uv venv venv --python 3.11
            source venv/bin/activate
            uv pip install -e .
          else
            cd depictio/cli
            python3 -m venv venv
            source venv/bin/activate
            pip install -e .
          fi

      - name: Get admin token from backend pod
        id: token
        run: |
          BACKEND_POD=$(kubectl get pods -n datasci-depictio-project-demo \
            -l release=demo,app=depictio-backend \
            -o jsonpath='{.items[0].metadata.name}')

          echo "Getting admin config from pod: ${BACKEND_POD}"
          kubectl cp datasci-depictio-project-demo/${BACKEND_POD}:/app/depictio/.depictio/admin_config.yaml ./admin_config.yaml

          TOKEN=$(grep 'access_token' admin_config.yaml | awk '{print $2}' | tr -d "'\"")
          echo "::add-mask::${TOKEN}"
          echo "token=${TOKEN}" >> $GITHUB_OUTPUT

      - name: Register Iris demo project
        run: |
          cd depictio/cli
          source venv/bin/activate

          echo "ðŸ“Š Registering Iris demo project..."
          depictio-cli config validate-project-config \
            --project-config-path ../api/v1/configs/iris_dataset/initial_project_cli.yaml \
            --CLI-config-path ../../admin_config.yaml || true

      - name: Cleanup
        if: always()
        run: |
          rm -f admin_config.yaml
