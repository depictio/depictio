# Screenshot System â€” Dash 3+ Component Targeting

## Problem

With Dash 3+ and Mantine AppShell, targeting `.mantine-AppShell-main` captures the full viewport (1920x1080) including navbar/header. Parent containers (`#page-content`, `#draggable`, `.react-grid-layout`) collapse to 0px height with absolutely positioned children.

## Solution: Component-Based Composite Screenshots

**Primary method**: Target individual `.react-grid-item` elements, calculate bounding box, capture composite area.

**Fallback chain**:
1. Component composite screenshot (preferred)
2. AppShell main element (legacy)
3. Full page screenshot (final fallback)

## Implementation

**Location**: `routes.py:screenshot_dash_fixed()`

```python
# Wait for components to render with meaningful dimensions
await page.wait_for_function("""
    () => {
        const components = document.querySelectorAll('.react-grid-item');
        if (components.length === 0) return false;
        for (let component of components) {
            const rect = component.getBoundingClientRect();
            if (rect.width > 0 && rect.height > 0) return true;
        }
        return false;
    }
""", timeout=10000)

# Calculate bounding box of all components
composite_element = await page.evaluate("""
    () => {
        const components = document.querySelectorAll('.react-grid-item');
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        components.forEach(c => {
            const rect = c.getBoundingClientRect();
            minX = Math.min(minX, rect.left);
            minY = Math.min(minY, rect.top);
            maxX = Math.max(maxX, rect.right);
            maxY = Math.max(maxY, rect.bottom);
        });
        const container = document.createElement('div');
        container.id = 'temp-screenshot-container';
        container.style.cssText = `position:absolute;left:${minX}px;top:${minY}px;width:${maxX-minX}px;height:${maxY-minY}px`;
        document.body.appendChild(container);
        return { width: maxX - minX, height: maxY - minY, componentCount: components.length };
    }
""")

# Screenshot composite area, then clean up temp element
temp_container = await page.query_selector('#temp-screenshot-container')
await temp_container.screenshot(path=output_file)
```

## Testing

**Debug script**: `dev/playwright_debug/mantine_appshell_debug.py`
- Uses credentials from `depictio/.depictio/admin_config.yaml`
- Validates individual `.react-grid-item` targeting
- Creates both individual and composite screenshots

## Key Notes

- Requires `.react-grid-item` components to be present and rendered
- Includes smart waiting for component rendering with proper dimensions
- Graceful fallback if component targeting fails
- Temp DOM elements are cleaned up after screenshot


<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

*No recent activity*
</claude-mem-context>