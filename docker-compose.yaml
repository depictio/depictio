# ============================================================================
# DEPICTIO DOCKER COMPOSE - QUICK START
# ============================================================================
# This is the main docker-compose file for running Depictio with pre-built images.
# MinIO (S3-compatible object storage) is bundled by default — no extra files needed.
#
# QUICK START (no git clone required):
#   curl -LO https://raw.githubusercontent.com/depictio/depictio/main/docker-compose.yaml
#   docker compose up -d
#   → http://localhost:5080
#
# COMMANDS:
#   Start:  docker compose up -d
#   Stop:   docker compose down
#   Logs:   docker compose logs -f
#   Status: docker compose ps
#
# EXTERNAL S3 (advanced):
#   Use docker-compose/docker-compose.no-minio.yaml if you bring your own S3/MinIO:
#   docker compose -f docker-compose/docker-compose.no-minio.yaml up -d
#
# DEVELOPMENT:
#   For local development with hot-reload, use docker-compose.dev.yaml instead.
#
# CONFIGURATION:
#   - Minimal config: .env.example (copy to .env to override credentials)
#   - Complete reference: .env.complete.example
#   - Documentation: https://depictio.github.io/depictio/installation/configuration
# ============================================================================

services:
  mongo:
    image: mongo:8.0.14
    container_name: mongo
    command: mongod --port 27018
    ports:
      - 27018:27018
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD-SHELL", "mongosh --port 27018 --eval 'db.adminCommand(\"ping\")'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  redis:
    image: redis:8.2.1
    container_name: redis
    ports:
      - 6379:6379
    volumes:
      - redis_data:/data
    command: redis-server
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  minio:
    image: minio/minio:RELEASE.2025-01-20T14-49-07Z
    container_name: minio
    ports:
      - ${MINIO_PORT:-9000}:9000
      - ${MINIO_CONSOLE_PORT:-9001}:9001
    volumes:
      - minio_data:/data
    environment:
      MINIO_ROOT_USER: ${DEPICTIO_MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${DEPICTIO_MINIO_ROOT_PASSWORD:-minio123}
    command: server /data --console-address :9001
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9000/minio/health/live || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  depictio-frontend:
    image: ghcr.io/depictio/depictio:${DEPICTIO_VERSION:-latest}
    container_name: depictio-frontend
    ports:
      - 5080:5080
    env_file:
      - path: .env
        required: false
    environment:
      DEPICTIO_AUTH_SINGLE_USER_MODE: "${DEPICTIO_AUTH_SINGLE_USER_MODE:-true}"
      DEPICTIO_MINIO_ROOT_USER: "${DEPICTIO_MINIO_ROOT_USER:-minio}"
      DEPICTIO_MINIO_ROOT_PASSWORD: "${DEPICTIO_MINIO_ROOT_PASSWORD:-minio123}"
    command: ["/app/run_dash.sh"]
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:5080/ > /dev/null"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
      depictio-backend:
        condition: service_healthy
      minio:
        condition: service_healthy

  depictio-backend:
    image: ghcr.io/depictio/depictio:${DEPICTIO_VERSION:-latest}
    container_name: depictio-backend
    ports:
      - 8058:8058
    env_file:
      - path: .env
        required: false
    environment:
      DEPICTIO_AUTH_SINGLE_USER_MODE: "${DEPICTIO_AUTH_SINGLE_USER_MODE:-true}"
      DEPICTIO_MINIO_ROOT_USER: "${DEPICTIO_MINIO_ROOT_USER:-minio}"
      DEPICTIO_MINIO_ROOT_PASSWORD: "${DEPICTIO_MINIO_ROOT_PASSWORD:-minio123}"
    command: ["/app/run_fastapi.sh"]
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8058/health > /dev/null"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy

  depictio-celery-worker:
    container_name: depictio-celery-worker
    # Always enabled - required for design mode (stepper) to work
    # Dashboard editor will fail without Celery worker running
    image: ghcr.io/depictio/depictio:${DEPICTIO_VERSION:-latest}
    env_file:
      - path: .env
        required: false
    environment:
      DEPICTIO_CONTEXT: "server"
      DEPICTIO_AUTH_SINGLE_USER_MODE: "${DEPICTIO_AUTH_SINGLE_USER_MODE:-true}"
      DEPICTIO_MINIO_ROOT_USER: "${DEPICTIO_MINIO_ROOT_USER:-minio}"
      DEPICTIO_MINIO_ROOT_PASSWORD: "${DEPICTIO_MINIO_ROOT_PASSWORD:-minio123}"
    command: ["/app/run_celery_worker.sh"]
    restart: unless-stopped
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
      depictio-backend:
        condition: service_healthy

volumes:
  mongo_data:
    driver: local
  redis_data:
    driver: local
  minio_data:
    driver: local
