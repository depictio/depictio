services:
  mongo:
    image: mongo:8.0
    container_name: mongo
    command: mongod --dbpath /data/depictioDB --port 27018 --logpath /dev/null
    user: "${UID:-1000}:${GID:-1000}"
    ports:
      - 27018:27018
    volumes:
      - ./depictioDB:/data/depictioDB

  redis:
    image: redis:8.2.1
    container_name: redis
    ports:
      - 6379:6379
    volumes:
      - redis_data:/data
    command: redis-server
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 3s
      retries: 5

  depictio-frontend:
    image: ghcr.io/depictio/depictio:${DEPICTIO_VERSION:-latest}
    container_name: depictio-frontend
    ports:
      - 5080:5080
    volumes:
      - ./depictio:/app/depictio
    env_file:
      - .env
    command: ["/app/run_dash.sh"]
    user: "${UID:-1000}:${GID:-1000}"
    depends_on:
      - mongo
      - redis
      - depictio-backend

  depictio-backend:
    image: ghcr.io/depictio/depictio:${DEPICTIO_VERSION:-latest}
    container_name: depictio-backend
    ports:
      - 8058:8058
    volumes:
      - ./depictio:/app/depictio
    env_file:
      - .env
    command: ["/app/run_fastapi.sh"]
    user: "${UID:-1000}:${GID:-1000}"
    depends_on:
      - mongo
      - redis

  depictio-celery-worker:
    container_name: depictio-celery-worker
    # Always enabled - required for design mode (stepper) to work
    # Dashboard editor will fail without Celery worker running
    image: ghcr.io/depictio/depictio:${DEPICTIO_VERSION:-latest}
    volumes:
      - ./depictio:/app/depictio
    env_file:
      - .env
    environment:
        DEPICTIO_CONTEXT: "server"
    command: ["/app/run_celery_worker.sh"]
    user: "${UID:-1000}:${GID:-1000}"
    depends_on:
      - mongo
      - redis
      - depictio-backend

volumes:
  redis_data:
    driver: local
