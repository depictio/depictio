version: '3.8'

services:
  mongo:
    image: mongo:latest
    command: --dbpath ${MONGO_DBPATH} --port ${MONGO_PORT}
    ports:
      - "${MONGO_PORT}:${MONGO_PORT}"
    volumes:
      - "${MONGO_VOLUME_HOST}:${MONGO_VOLUME_CONTAINER}"

  redis:
    image: redis:latest
    command: redis-server
    ports:
      - "${REDIS_PORT}:${REDIS_PORT}"

  redis-cli-monitor:
    image: redis:latest
    command: redis-cli -h redis monitor
    depends_on:
      - redis

  minio:
    image: minio/minio:latest
    volumes:
      - "${MINIO_VOLUME}:${MINIO_VOLUME}"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
    command: server /data --console-address :${MINIO_CONSOLE_PORT}
    ports:
      - "${MINIO_SERVER_PORT}:${MINIO_SERVER_PORT}"
      - "${MINIO_CONSOLE_PORT}:${MINIO_CONSOLE_PORT}"

  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "${RABBITMQ_PORT}:${RABBITMQ_PORT}"
      - "${RABBITMQ_MANAGEMENT_PORT}:${RABBITMQ_MANAGEMENT_PORT}"

  jbrowse2:
    image: jbrowse2:latest
    build:
      dockerfile: docker-images/Dockerfile_jbrowse.dev.plugin.dockerfile
    ports: 
      - "${JBROWSE2_PORT1}:${JBROWSE2_PORT1}"
      - "${JBROWSE2_PORT2}:${JBROWSE2_PORT2}"
    volumes:
      - "${JBROWSE2_PLUGIN_VOLUME_HOST}:${JBROWSE2_PLUGIN_VOLUME_CONTAINER}"

  depictio_frontend:
    image: depictio:dev
    ports:
      - "${DEPICTIO_FRONTEND_PORT}:${DEPICTIO_FRONTEND_PORT}"
    volumes:
      - "${DEPICTIO_FRONTEND_VOLUME}:${DEPICTIO_FRONTEND_VOLUME}"
      - "${DEPICTIO_DATA_VOLUME}:${DEPICTIO_DATA_VOLUME}"
      - "${DEPICTIO_MINIO_DATA}:${DEPICTIO_MINIO_DATA}"
      - "${DEPICTIO_CLI_CONFIGS}:${DEPICTIO_CLI_CONFIGS}"
    command: ["python", "depictio/dash/app.py"]
    depends_on:
      - mongo
      - redis
      - minio
      - depictio_backend
      - rabbitmq

  depictio_backend:
    image: depictio:dev
    ports:
      - "${DEPICTIO_BACKEND_PORT}:${DEPICTIO_BACKEND_PORT}"
    volumes:
      - "${DEPICTIO_BACKEND_DATA_VOLUME_HOST}:${DEPICTIO_BACKEND_DATA_VOLUME_HOST}"
      - "${DEPICTIO_DATA_VOLUME}:${DEPICTIO_DATA_VOLUME}"
      - "${DEPICTIO_BACKEND_SESSIONS_HOST}:${DEPICTIO_BACKEND_SESSIONS_HOST}"
      - "${DEPICTIO_MINIO_DATA}:${DEPICTIO_MINIO_DATA}"
      - "${DEPICTIO_CLI_CONFIGS}:${DEPICTIO_CLI_CONFIGS}"
    command: ["python", "depictio/api/run.py"]
    depends_on:
      - mongo
      - redis
      - minio
      - rabbitmq

  depictio_nb:
    image: depictio_nb:dev
    ports:
      - "${DEPICTIO_NB_PORT}:${DEPICTIO_NB_PORT}"
    volumes:
      - "${DEPICTIO_BACKEND_DATA_VOLUME_HOST}:${DEPICTIO_BACKEND_DATA_VOLUME_HOST}"
      - "${DEPICTIO_DATA_VOLUME}:${DEPICTIO_DATA_VOLUME}"
      - "${DEPICTIO_NB_DEV}:${DEPICTIO_NB_DEV}"
      - "${DEPICTIO_BACKEND_SESSIONS_HOST}:${DEPICTIO_BACKEND_SESSIONS_HOST}"
      - "${DEPICTIO_MINIO_DATA}:${DEPICTIO_MINIO_DATA}"
      - "${DEPICTIO_CLI_CONFIGS}:${DEPICTIO_CLI_CONFIGS}"
    depends_on:
      - mongo
      - redis
      - minio
      - depictio_backend
      - rabbitmq
    command: ["jupyter", "lab", "--ip=0.0.0.0", "--allow-root"]
