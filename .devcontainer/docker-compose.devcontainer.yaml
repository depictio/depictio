services:
  app:
    # Use pre-built image from GHCR if available, fallback to local build
    # To use cached image: set DEVCONTAINER_IMAGE=ghcr.io/depictio/depictio-devcontainer:latest
    image: ${DEVCONTAINER_IMAGE:-}
    build:
      context: .
      dockerfile: .devcontainer/Dockerfile
      # Enable BuildKit cache
      cache_from:
        - ghcr.io/depictio/depictio-devcontainer:latest
        - ghcr.io/depictio/depictio-devcontainer:main
    init: true
    volumes:
      - .:/workspace:cached
      # Docker socket - use environment variable for Codespaces compatibility
      # In Codespaces, docker-outside-of-docker feature handles this automatically
      - ${DOCKER_SOCKET:-/var/run/docker.sock}:/var/run/docker.sock
      # Gemini and Qwen: direct bind mounts (working)
      - ~/.gemini:/home/vscode/.gemini
      - ~/.qwen:/home/vscode/.qwen
      # Claude Code: Docker volume (Mac/Linux credential incompatibility)
      - claude-code-config:/home/vscode/.claude
      # uv cache: Docker volume for fast package installation
      - uv-cache:/home/vscode/.cache/uv
    command: sleep infinity
    user: vscode
    depends_on:
      mongo:
        condition: service_started
      redis:
        condition: service_healthy
      minio:
        condition: service_started
      depictio-backend:
        condition: service_started
      depictio-frontend:
        condition: service_started
      depictio-celery-worker:
        condition: service_started
    environment:
      - DEPICTIO_CONTEXT=server
      - DEPICTIO_MONGODB_SERVICE_NAME=mongo
      - DEPICTIO_MONGODB_PORT=27018
      - DEPICTIO_MINIO_ROOT_USER=minio
      - DEPICTIO_MINIO_ROOT_PASSWORD=minio123
      - DEPICTIO_MINIO_ENDPOINT_URL=http://minio:9000
      - CLAUDE_CONFIG_DIR=/home/vscode/.claude

volumes:
  claude-code-config:
  uv-cache:
